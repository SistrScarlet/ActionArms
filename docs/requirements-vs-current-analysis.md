# ActionArms 要件定義書 vs 現状実装 詳細差異分析

**分析実施日:** 2025-06-14  
**対象文書:** `docs/item-system-specification.md` (v1.0, 2025-05-27)  
**現状ベース:** 知識の泉データ (files-index.json + 詳細カテゴリ情報)

## 📋 分析概要

ActionArms MODの要件定義書に対する現状実装の詳細差異分析。
銃器・弾薬・弾倉・操作・耐久・拡張システムの各分野における実装状況を評価。

## ✅ 完全実装済みシステム（100%達成）

### 🔫 銃器システム基盤

**レバーアクション機構**
- ✅ **FireTrigger インターフェース**: trigger()メソッドによる発射処理
- ✅ **CyclingLever インターフェース**: cycle()メソッドによるレバー操作
- ✅ **Reloadable インターフェース**: reload()メソッドによる弾薬装填
- ✅ **Chamber クラス**: 薬室のカートリッジ管理・発射・排出処理
- ✅ **Cartridge クラス**: 薬莢の実弾・空薬莢状態管理
- ✅ **LeverActionGunComponent**: 統合コンポーネント（約220行）

**コンポーネントベースアーキテクチャ**
- ✅ **IItemComponent インターフェース**: NBT読み書き・execute/query/updateメソッド
- ✅ **BaseItemComponent 基底クラス**: 共通機能実装
- ✅ **ComponentResult enum**: NO_CHANGE/MODIFIEDによる明確な状態管理
- ✅ **DataType と Component 分離設計**: 型安全なコンポーネント管理
- ✅ **レジストリシステム**: GunComponentTypes/GunDataTypesによる一元管理

**弾薬装填システム**
- ✅ **単発装填対応**: レバーアクション銃での個別弾薬装填
- ✅ **チューブマガジン（FILO）**: LinkedList実装による後入先出管理
- ✅ **弾薬互換性チェック**: Predicate<BulletComponent>による柔軟な互換性判定
- ✅ **実際の弾薬消費**: InventoryAmmoUtilによるインベントリ連携

### 🎯 操作システム

**専用キーバインド操作**
- ✅ **右クリック廃止**: use()メソッド削除、専用キーによる操作
- ✅ **KeyInputManager**: 汎用キー入力状態管理システム
- ✅ **ClientKeyInputManager**: クライアント側キー管理とサーバー同期
- ✅ **GunController**: プレイヤーの銃操作統合制御システム
- ✅ **AAKeys**: キーバインド定義とKeyInputManager連携

**エイム機能**
- ✅ **AimManager**: エイム状態管理（アイテム切り替え時自動解除）
- ✅ **ClientAimManager**: クライアント側エイム管理
- ✅ **トグル・プッシュ両対応**: 設定による操作方式切り替え
- ✅ **描画位置調整**: MixinHeldItemRendererによるエイム時中央配置
- ✅ **アニメーション連携**: エイム時アニメーション名サフィックス（*_aiming）

**レバーアクション操作**
- ✅ **射撃後コッキング必須**: leverDown/cycling/hammerReady状態管理
- ✅ **タイミング制御**: coolTime/cancelableTimeによる精密な操作制御
- ✅ **状態遷移管理**: tick()処理による自動状態更新

**リアルタイム同期**
- ✅ **ネットワークパケット**: KeyInputPacket/AimPacket/HudStatePacket
- ✅ **マルチプレイヤー対応**: 全操作のクライアント・サーバー間同期
- ✅ **Mixin機能注入**: MixinPlayerEntity/MixinServerPlayerEntityによる機能拡張

### 🎨 描画・レンダリングシステム

**glTF描画システム**
- ✅ **副作用ゼロ設計**: 中間オブジェクト完全削除の直接描画
- ✅ **カスタム3Dモデル**: GLTFModelItemインターフェースによる判定
- ✅ **MixinItemRenderer**: アイテム描画のカスタマイズ
- ✅ **MixinHeldItemRenderer**: 手持ちアイテム描画位置調整
- ✅ **アニメーション同期**: UUIDベースのアニメーション管理

### 🔊 音響システム

**統合サウンドシステム**
- ✅ **4種類のサウンドイベント**: 射撃・空撃ち・弾薬装填・コッキング
- ✅ **サウンドバリエーション**: 各種サウンドで4-8バリエーション
- ✅ **LeverActionPlaySoundContext**: サウンド再生の一元管理
- ✅ **Sound enum**: CYCLE/RELOAD/FIRE/DRY_FIREによる分類
- ✅ **音量・ピッチ制御**: SoundCategoryによる詳細制御

### 📊 視覚システム

**HUD描画システム**
- ✅ **AAHudRenderer**: 薬室・マガジン状況の視覚的表示
- ✅ **2つの表示方式**: 縦並び（右下）・横並び（上部中央）
- ✅ **弾薬テクスチャ表示**: 装填状況の直感的な視覚化
- ✅ **LeverActionHudState**: NBT対応の状態データ管理
- ✅ **リアルタイム同期**: ServerHudManager/ClientHudManagerによる効率的同期

### 🚀 エンティティシステム

**弾丸エンティティ**
- ✅ **BulletEntity**: 物理演算付き弾丸（217行実装）
- ✅ **ヘッドショット判定**: サイズ応動型判定システム
- ✅ **ハイブリッド当たり判定**: レイキャスト＋ProjectileUtilの併用
- ✅ **物理演算**: 重力・空気抵抗対応
- ✅ **所有者追跡**: UUID/Entityによる追跡システム

## ⚠️ 部分実装システム（30-70%達成）

### 💥 弾薬システム

**現状実装（30%）**
- ✅ **基本弾薬管理**: BulletComponent/BulletDataType実装
- ✅ **MIDDLE_CALIBER_BULLET**: 中口径弾薬アイテム登録
- ✅ **コンポーネントベース設計**: BulletItemとBulletComponentの連携
- ✅ **ダメージ・ヘッドショットダメージ**: 基本パラメータ実装

**未実装要素（70%）**
- ❌ **小口径弾薬**: 拳銃・小型ライフル用
- ❌ **大口径弾薬**: 大型ライフル・狙撃銃用  
- ❌ **特大口径弾薬**: 対物ライフル・重機関銃用
- ❌ **弾種バリエーション**: 通常弾・徹甲弾・炸裂弾・焼夷弾
- ❌ **材質による差別化**: 鉛・銅・鉄・特殊合金の性能差
- ❌ **弾薬選択機能**: インベントリ内弾薬種別指定

### 📦 弾倉システム

**現状実装（40%）**
- ✅ **チューブマガジン**: LEVER_ACTION_TUBE_MAGAZINE実装
- ✅ **弾薬互換性**: Predicate<BulletComponent>による判定
- ✅ **MagazineComponent**: BaseItemComponent継承の統合実装
- ✅ **容量管理**: capacityパラメータによる弾数制限

**未実装要素（60%）**
- ❌ **容量バリエーション**: 5発/10発/30発/ドラム（100発）
- ❌ **材質差別化**: 木製/鉄製/合金製による重量・耐久性・装填速度差
- ❌ **専用弾倉システム**: 高性能銃器の専用弾倉要求
- ❌ **弾倉交換システム**: オートマチック銃での弾倉交換操作

### 🔫 銃器バリエーション

**現状実装（20%）**
- ✅ **レバーアクション**: M1873完全実装
- ✅ **マニュアル操作**: レバーアクション機構の詳細実装

**未実装要素（80%）**
- ❌ **拳銃**: セミオート・リボルバー
- ❌ **ライフル**: セミオート・フルオート
- ❌ **ショットガン**: シングル・ダブル・ポンプアクション
- ❌ **特殊銃器**: 狙撃銃・機関銃・グレネードランチャー

## ❌ 完全未実装システム（0%達成）

### 🏷️ タグベース分類システム

**基本分類タグ**
- ❌ 拳銃（Pistol）タグ
- ❌ ライフル（Rifle）タグ  
- ❌ ショットガン（Shotgun）タグ
- ❌ 特殊（Special）タグ

**口径タグ**
- ❌ 小口径（Small Caliber）タグ
- ❌ 中口径（Medium Caliber）タグ - 実装済みだがタグ化未対応
- ❌ 大口径（Large Caliber）タグ
- ❌ 特大口径（Extra Large Caliber）タグ

**機構タグ**
- ❌ オート（Auto）タグ
- ❌ セミオート（Semi-Auto）タグ
- ❌ マニュアル（Manual）タグ - 実装済みだがタグ化未対応
- ❌ シングル（Single）タグ

**特性タグ**
- ❌ 精密（Precision）タグ
- ❌ 制圧（Suppression）タグ
- ❌ 近接（Close Range）タグ
- ❌ 遠距離（Long Range）タグ

### 🔧 耐久・故障システム

**段階的劣化システム**
- ❌ 耐久値による性能劣化（100% → 75% → 50% → 25% → 0%）
- ❌ 軽微な性能低下段階（75% → 50%）
- ❌ 明確な性能低下＋稀なジャム段階（50% → 25%）
- ❌ 頻繁なジャム＋大幅性能低下段階（25% → 0%）

**故障機能**
- ❌ ジャム発生システム（確率的故障）
- ❌ ジャム解除操作（プレイヤーによる手動解除）
- ❌ 故障率の耐久値依存（低耐久値で高故障率）

**修理システム**
- ❌ メンテナンスキットアイテム
- ❌ 使用回数制限（完全修理不可設計）
- ❌ 最大耐久値減少システム（経済循環促進）
- ❌ 最終的な廃棄必要設計

### ⚙️ 操作システム拡張

**弾薬選択システム**
- ❌ 弾薬選択キーバインド
- ❌ インベントリ内弾薬種別指定UI
- ❌ 弾薬種別による性能変化

**タクティカルリロード**
- ❌ 弾薬ポーチ専用アイテム
- ❌ 中途半端な弾倉の一時格納
- ❌ 弾倉整理・統合機能
- ❌ ポーチのアップグレード要素（容量・自動整理機能）

**操作簡略化パーツ**
- ❌ レバーアクション自動化パーツ
- ❌ 射撃後コッキング自動化
- ❌ トレードオフ設計（操作時間延長）

### 📈 拡張システム

**カスタマイズシステム**
- ❌ 性能微調整機能
- ❌ アタッチメント（スコープ・サイレンサー・etc）
- ❌ 改造パーツシステム

**強化システム**
- ❌ 銃器補正値強化
- ❌ エンチャント類似システム
- ❌ ランダム性高コストシステム
- ❌ 限界追求の高コスト設計

### 🏭 製造システム

**弾薬製造**
- ❌ 火薬 + 金属 + ケース組み合わせ
- ❌ 口径別製造レシピ
- ❌ 材質別製造バリエーション

**銃器製造**
- ❌ 部品組み立てシステム
- ❌ 材質・品質による性能差

**弾倉製造**
- ❌ 容量・材質による製造バリエーション
- ❌ 専用弾倉の高コスト製造

## 🔍 実装度統計

| システム分野 | 実装度 | 主要要素 |
|------------|---------|----------|
| **銃器基盤** | 95% | レバーアクション完全実装、コンポーネント設計完成 |
| **操作システム** | 90% | キーバインド・エイム・同期完全対応 |
| **描画・音響** | 95% | glTF・HUD・サウンド完全実装 |
| **弾薬システム** | 30% | 中口径のみ、他口径・弾種未実装 |
| **弾倉システム** | 40% | チューブマガジンのみ、容量・材質バリエーション未実装 |
| **タグ分類** | 0% | 分類システム完全未実装 |
| **耐久・故障** | 0% | 劣化・ジャム・修理システム未実装 |
| **拡張機能** | 5% | 基本システムのみ、カスタマイズ・強化未実装 |
| **製造システム** | 0% | 製造レシピ・クラフト未実装 |

**全体実装度: 約40%**

## 📝 分析まとめ

**強み**
- 銃器システムの基盤とアーキテクチャが非常に堅牢
- レバーアクション機構の完全実装により、他の銃器タイプへの拡張基盤が完成
- マルチプレイヤー対応・リアルタイム同期が完璧
- 描画・音響システムが完全実装済み

**改善点**
- 弾薬・弾倉のバリエーション不足（現在1種類ずつのみ）
- タグベース分類システムの完全欠如
- 耐久・故障システムによるリアリズム要素の欠如
- 製造システムによるゲーム性拡張の未実装

**次段階への示唆**
現状では非常に堅固な基盤システムが完成しており、要件定義書の「機構と操作の心地よさ」は十分に達成。今後は多様性（弾薬・弾倉・銃器バリエーション）とリアリズム（耐久・故障システム）の追加が重要。

---
*分析実施者: ソラン（知識の泉活用システム）*  
*次回更新予定: 実装計画策定後*